
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Setting Up The ev3dev Build Ecosystem (obsolete)</title>
    
    <!-- Description content not available -->
    
    <link rel="alternate" type="application/atom+xml" href="/ev3dev.github.io/news/atom.xml" title="Atom feed">
    <link rel="icon" href="/ev3dev.github.io/favicon.ico" />

    <!-- Bootstrap styles -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/bootstrap.css">

    <!-- Custom styles -->
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/site-structure.css">
    <link rel="stylesheet" href="/ev3dev.github.io/stylesheets/landing-content.css">

    <!-- Template for search results -->
    <script type="text/html" id="search-result-template">
        <div class="search-result">
            <a data-href="href"><h4 data-content="title"></h4></a>
            <span data-content="breadcrumbs" class="search-result-breadcrumbs"></span>
            <span data-content="author" class="search-result-author"></span><br/>
        </div>
    </script>

    

    
        <!-- Google Analytics excluded: not an official site build -->
    
</head>


<body class="no-jumbotron ">

    <div id="header">
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/ev3dev.github.io/">
                    <img id="brand-logo" src="/ev3dev.github.io/images/ev3dev_logo_white.png" alt="ev3dev logo" />
                </a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav" id="main-nav">
                    <li>
                        <a href="/ev3dev.github.io/docs/getting-started" title="Our Getting Started guide">Start Here</a>
                    </li>
                    <li>
                        <a href="/ev3dev.github.io/download" title="SD card images for ev3dev">Downloads</a>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" title="Documentation on using ev3dev">
                            Documentation
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="/ev3dev.github.io/docs/tutorials">Tutorials</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/docs/programming-languages">Programming Languages</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/docs/networking">Networking</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/docs/driver-overview">Hardware Drivers</a>
                            </li>
                            <li role="separator" class="divider"></li>
                            <li>
                                <a href="/ev3dev.github.io/docs">More...</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="/ev3dev.github.io/support" title="Get Help with ev3dev">Support</a>
                    </li>
                    <li>
                        <a href="/ev3dev.github.io/news" title="ev3dev news">News</a>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            Community
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="/ev3dev.github.io/contribute" title="How to contribute to ev3dev">Contribute</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/share" title="Share the word on ev3dev with others">Share</a>
                            </li>
                            <li>
                                <a href="/ev3dev.github.io/projects" title="Discover projects that use ev3dev">Project showcase</a>
                            </li>
                        </ul>
                    </li>
                </ul>
                <!-- items below float right, so appear in reverse order -->
                <div id="search-container">
                    <form class="navbar-form navbar-right dropdown" onsubmit="return false;">
                        <input type="text" id="search-input" class="form-control" placeholder="Quick nav" autocomplete="off" />
                        <div class="dropdown-menu" id="search-dropdown">
                            <div class="search-results-container" id="search-no-data-warning">
                                <span class="glyphicon glyphicon-alert heading-icon" aria-hidden="true"></span>
                                We were unable to retrieve search data from the
                                server. Make sure that JavaScript is enabled and
                                that nothing is blocking network access.
                            </div>

                            <div class="search-results-container" id="search-results-docs">
                                <h2>In docs</h2>
                                <div data-content="docs-results">
                                    <div class="no-results-note">No results</div>
                                </div>
                            </div>

                            <div class="search-results-container" id="search-results-projects">
                                <h2>In projects</h2>
                                <div data-content="project-results">
                                    <div class="no-results-note">No results</div>
                                </div>
                            </div>

                            <div class="search-results-container" id="search-results-news">
                                <h2>In news</h2>
                                <div data-content="news-results">
                                    <div class="no-results-note">No results</div>
                                </div>
                            </div>

                            <div class="search-results-container" id="search-results-misc">
                                <h2>In other pages</h2>
                                <div data-content="misc-results">
                                    <div class="no-results-note">No results</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </nav>
</div>

    
    
    <div class="container">
        

<div class="page-header">
    
        <a class="btn btn-primary pull-right" href="https://github.com/ev3dev/ev3dev.github.io/edit/master/docs/devtools/setting-up-the-ev3dev-build-ecosystem.md"><span class="glyphicon glyphicon-pencil"></span> Edit on Github</a>
    
    <h1>
        Setting Up The ev3dev Build Ecosystem (obsolete)
        <small></small>
    </h1>
</div>
    </div>
    
    
    <div class="container">
    
        

<hr />
<div class="nav-dropdown-arrow">
    <div>
        

<ol class="breadcrumb" vocab="http://schema.org" typeof="BreadcrumbList">
    
    

    
        

        
        

        <li property="itemListElement" typeof="ListItem" class="">
            <a href="/ev3dev.github.io/docs/" property="item" typeof="WebPage">
                <span property="name">Documentation</span>
            </a>
            <meta property="position" content="1">
        </li>
        
    
        

        
        

        <li property="itemListElement" typeof="ListItem" class="">
            <a href="/ev3dev.github.io/docs/devtools/" property="item" typeof="WebPage">
                <span property="name">Developer Tools</span>
            </a>
            <meta property="position" content="2">
        </li>
        
    
        

        
        

        <li property="itemListElement" typeof="ListItem" class="active">
            <span href="/ev3dev.github.io/docs/devtools/" property="item" typeof="WebPage">
                <span property="name">Setting Up The ev3dev Build Ecosystem (obsolete)</span>
            </span>
            <meta property="position" content="3">
        </li>
        
    
</ol>
    </div>
    
</div>
<hr />



<p class="alert alert-danger"><span class="glyphicon glyphicon-exclamation-sign " aria-hidden="true"></span>
This page is obsolete. We now use <a href="https://www.docker.com" class="alert-link">Docker</a>
for managing ev3dev image builds.</p>

<ul id="markdown-toc">
  <li><a href="#why-use-virtual-machines-for-development" id="markdown-toc-why-use-virtual-machines-for-development">Why Use Virtual Machines For Development</a></li>
  <li><a href="#building-the-kernel" id="markdown-toc-building-the-kernel">Building the Kernel</a></li>
  <li><a href="#overview-of-brickstrap" id="markdown-toc-overview-of-brickstrap">Overview of brickstrap</a></li>
  <li><a href="#set-up-a-webserver" id="markdown-toc-set-up-a-webserver">Set Up A Webserver</a></li>
  <li><a href="#set-up-a-local-package-repository" id="markdown-toc-set-up-a-local-package-repository">Set Up A Local Package Repository</a>    <ul>
      <li><a href="#seeds-and-crops-and-packages" id="markdown-toc-seeds-and-crops-and-packages">Seeds and Crops and Packages</a></li>
      <li><a href="#harvesting-crops-and-populating-a-local-mirror" id="markdown-toc-harvesting-crops-and-populating-a-local-mirror">Harvesting Crops and Populating a Local Mirror</a></li>
    </ul>
  </li>
  <li><a href="#set-up-the-reprepro-system" id="markdown-toc-set-up-the-reprepro-system">Set Up The reprepro System</a>    <ul>
      <li><a href="#create-folder-structure-for-each-local-respository" id="markdown-toc-create-folder-structure-for-each-local-respository">Create Folder Structure For Each Local Respository</a></li>
      <li><a href="#get-the-gpg-keys-for-each-repository" id="markdown-toc-get-the-gpg-keys-for-each-repository">Get the GPG Keys For Each Repository</a></li>
      <li><a href="#create-the-package-lists-and-populate-the-repositories" id="markdown-toc-create-the-package-lists-and-populate-the-repositories">Create The Package Lists and Populate The Repositories</a></li>
    </ul>
  </li>
  <li><a href="#configuring-your-webserver-to-serve-packages" id="markdown-toc-configuring-your-webserver-to-serve-packages">Configuring Your Webserver To Serve Packages</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<p>This is a set of notes that are helpful to get the full <a href="http://www.ev3dev.org">ev3dev</a>
development environment up and running. It assumes that you
are comfortable with:</p>

<ol>
  <li>Basic Linux command line usage</li>
  <li>Installing Linux software from packages</li>
  <li>Setting up a <a href="https://www.virtualbox.org/">VirtualBox</a> VM</li>
  <li>Setting up a web server</li>
  <li>Setting up <code class="highlighter-rouge">nfs</code> to share folders</li>
</ol>

<h2 id="why-use-virtual-machines-for-development">Why Use Virtual Machines For Development</h2>

<p>I like to use VMs for development - it lets me make sure that programs
and procedures work on mulitple platforms.</p>

<p>If you develop programs on multiple VMs, it can use a LOT of disk space
if the source is duplicated for each VMs. Instead, I keep the source
(usually in a git repo) on the host and
use nfs to make directories available on the VMs. With a regular
spinning disk and a slow laptop, this made builds slower. Now that I
have a faster laptop with an SSD, it’s not such a big deal.</p>

<p>There’s another advantage that you might not have considered
either - you only need to keep track of your source in one place
and you can edit and navigate the source using your host machine’s
tools instead of having to manually install them in each VM.</p>

<h2 id="building-the-kernel">Building the Kernel</h2>

<p>I keep the <code class="highlighter-rouge">ev3dev-kernel</code> and <code class="highlighter-rouge">ev3dev-buildscripts</code> source as a
git repo on the host in:</p>

<ul>
  <li><code class="highlighter-rouge">~/Downloads/gitRepos/ev3dev-kernel</code></li>
  <li><code class="highlighter-rouge">~/Downloads/gitRepos/ev3dev-buildscripts</code></li>
</ul>

<p>Before you can actually build the kernel, you need to install the
required tools. Again, it’s a tossup on how you want to manage the
executables - the ARM toolchain is pretty big so I tend to put it
on the host and then share it across VMs.</p>

<p>The <a href="https://github.com/ev3dev/ev3dev-buildscripts">ev3dev-buildscripts</a> repository already
has a script called <code class="highlighter-rouge">install-kernel-build-tools</code> that you can run
as-is on your virtual machine. If you want to install the ARM toolchain
on your host computer then just run the script and use the intructions
in the README for <a href="https://github.com/ev3dev/ev3dev-buildscripts">ev3dev-buildscripts</a> to
build the kernel.</p>

<p>If you want to install the ARM toolchain on your host computer
and then share it, the easiest way is actually to install it on
one your target virtual machine and then copy the result out
to the host.</p>

<p>I’m assuming that the target VM is already set up for developing
the <code class="highlighter-rouge">ev3dev</code> kernel.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Do this on your target VM!
#
sudo apt-get -y --no-install-recommends install code-sourcery-toolchain-arm-2011.03
sudo mv /opt/arm-2011.03 $HOME/projects
</code></pre>
</div>

<p>Now the <code class="highlighter-rouge">arm-2011.03</code> folder should appear in the folder corresponding to
your VM on your host machine - in this case <code class="highlighter-rouge">/path/to/nfs/ev3dev-tahr64</code> - and
it still has <code class="highlighter-rouge">root</code> ownership. All we need to do is put it up in <code class="highlighter-rouge">/opt</code> on
the host and make it available to other VMs using the <code class="highlighter-rouge">/etc/exportfs</code> folder.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Do this on your host computer
#
sudo mv /path/to/nfs/ev3dev-tahr64/arm-2011.03 /opt
</code></pre>
</div>

<p>OK, now we have the <code class="highlighter-rouge">ev3dev-kernel</code> source, the <code class="highlighter-rouge">ev3dev-buildscripts</code> scripts,
and the <code class="highlighter-rouge">arm-2011.03</code> on the host machine, all we need to do is make them 
available on the VM target. As <code class="highlighter-rouge">root</code> on your host machine, edit <code class="highlighter-rouge">/etc/exports</code>
so that it has these extra lines:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># host /etc/exports additions - substitute use your own userid
#
/home/userid/Downloads/gitRepos/ev3dev-kernel       192.168.56.*(rw,sync,no_subtree_check,no_root_squash)
/home/userid/Downloads/gitRepos/ev3dev-buildscripts 192.168.56.*(rw,sync,no_subtree_check,no_root_squash)
/opt/arm-2011.03                                    192.168.56.*(rw,sync,no_subtree_check,no_root_squash)
</code></pre>
</div>

<p>You’ll need to update the <code class="highlighter-rouge">export</code>ed directories afterwards:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo exportfs -r
sudo exportfs -u
</code></pre>
</div>

<p>And on your VM, edit the <code class="highlighter-rouge">/etc/fstab</code> to mount those exported directories:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># vm /etc/fstab additions - substitute use your own userid
#
192.168.56.1:/home/userid/nfs/ev3dev-tahr64                      /home/userid/projects            nfs vers=3 0 0
192.168.56.1:/home/userid/Downloads/gitRepos/ev3dev-kernel       /home/userid/ev3dev-kernel       nfs vers=3 0 0
192.168.56.1:/home/userid/Downloads/gitRepos/ev3dev-buildscripts /home/userid/ev3dev-buildscripts nfs vers=3 0 0
192.168.56.1:/opt/arm-2011.03                                    /opt/arm-2011.03                 nfs vers=3 0 0
</code></pre>
</div>

<p>And then create the mountpoints and automount the new shares:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mkdir -p ~/ev3dev-kernel
mkdir -p ~/ev3dev-buildscripts

sudo mkdir -p /opt/arm-2011.03
sudo mount -a
</code></pre>
</div>

<p>Finally, you’ll need to install a few additional packages on your VM
to do a full kernel build:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Install missing kernel build tools on the vm:
#
sudo apt-get --no-install-recommends install ncurses-dev libc6-i386 bc u-boot-tools fakeroot
</code></pre>
</div>

<p>Now you can go ahead and build the kernel by following the directions 
on the official <a href="https://github.com/ev3dev/ev3dev-buildscripts">ev3dev-buildscripts</a> page. There
are also directions for repackaging the kernel for distribution.</p>

<h2 id="overview-of-brickstrap">Overview of brickstrap</h2>

<p>The <a href="https://github.com/ev3dev/brickstrap"><code class="highlighter-rouge">brickstrap</code></a> tool is used to build the root filesystem
that will eventually become the SD card image used to run <code class="highlighter-rouge">eve3dev</code> on
the LEGO MINDSTORMS EV3. It’s pretty much a hands-off script once you have the
whole ecosystem setup. If you are interested in building your own SD card
image, or if you want to compile programs that will run under <code class="highlighter-rouge">ev3dev</code> without
installing a compiler on the EV3, then you’ll need to use <code class="highlighter-rouge">brickstrap</code>.</p>

<p>You can do it the “easy” way and just run <code class="highlighter-rouge">brickstrap</code> from your main
development machine, or you can run it from your development VM - I choose
the latter option to make it easier to isolate issues and to make the
VM more portable to other machines. No matter which way you do it, you’ll probably
make mistakes and need to build the SD card image more than once, and each
time you build the image you’ll need to download 100’s of MB of package files.</p>

<p>If you want to save time and bandwidth, you’ll spend some time up front
and set up an ecosystem that lets you download the package files once, and
then serve them up locally whenever you need them. To do this you’ll need
a webserver and a partial mirror of the repositories where the packages
are normally loaded from.</p>

<p>If you don’t care about time and network bandwidth, skip the sections on
setting up a webserver and local package repository.</p>

<h2 id="set-up-a-webserver">Set Up A Webserver</h2>

<p>You can use pretty much any webserver that supports the concept of virtual
hosts. We’ll be directing virtual host names like <code class="highlighter-rouge">http://ev3dev.jessie.armel.hostname.com</code>
to bind to the default VirtualBox host-only interface at <code class="highlighter-rouge">192.168.56.1</code>. Each
of the virtual hostnames will be served up from a different directory.</p>

<p>I happen to like <a href="https://www.hiawatha-webserver.org/">Hiawatha</a> for this task because it’s lightweight, easy to 
configure, and rock solid. We’ll get into the specific steps later, for now
you need to think about which webserver you’ll want to use - maybe your host
machine already has one.</p>

<h2 id="set-up-a-local-package-repository">Set Up A Local Package Repository</h2>

<p>Believe me when I say you’ll be happy for the improved image build times
if you set up a local package repository now. Fortunately this is nowhere
near as complex as it sounds because of two tools that you can install
on your host machine:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>apt-get --no-install-recommends install germinate reprepro
</code></pre>
</div>

<p>The <a href="http://manpages.ubuntu.com/manpages/xenial/en/man1/germinate.1.html"><code class="highlighter-rouge">germinate</code></a> tool takes a list of the top level packages that you want
to have on the SD card image and generates a list of all the required dependencies.
We’ll massage the output of <code class="highlighter-rouge">germinate</code> to create a package list that can
be used to set up the local repositories using <code class="highlighter-rouge">reprepro</code>. Let’s start with
the <code class="highlighter-rouge">germinate</code> setup.</p>

<h3 id="seeds-and-crops-and-packages">Seeds and Crops and Packages</h3>

<p>If there’s one thing I get a kick out of, it’s a good metaphor. The idea of
<code class="highlighter-rouge">germinate</code> is to provide a list of <em>seed</em> packages from which we can
create a complete required package list. I’ve extended the metaphor a bit
further because I actually need to create a number of package lists that are
satisfied by different repositories:</p>

<ul>
  <li>The official Debian package repository</li>
  <li>The ev3dev specific package repository</li>
  <li>The third party repos for other source packages</li>
</ul>

<p>Naturally, these repositories are accessed via different URLs on the
web, so I’ve added the concept of <em>farms</em> to the metaphor. Each farm
stores a <code class="highlighter-rouge">conf</code> file that is used to tell <code class="highlighter-rouge">germinate</code> where it should
try to get the package dependency files that it needs.</p>

<p>The whole thing is tied together by a script called <code class="highlighter-rouge">grow_crop</code> - it takes 
the name of a farm (which matches the name of the corresponding seed directory)
and creates output in a corresponding folder in the <code class="highlighter-rouge">crops</code> directory. You
can delete the <code class="highlighter-rouge">crops</code> folder any time you like, the <code class="highlighter-rouge">grow_crop</code> script will
regenerate the <code class="highlighter-rouge">crops</code> file structure if needed.</p>

<p>The easiest way to get the folders all set up for <code class="highlighter-rouge">ev3dev</code> is to grab the
files from the <a href="https://github.com/rhempel/growrepo"><code class="highlighter-rouge">growrepo</code></a> repository on GitHub - it contains the files I
have used to build the SD card image for <code class="highlighter-rouge">ev3dev</code> according to this
<code class="highlighter-rouge">STRUCTURE</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>required:
minimal: required
standard: required minimal
custom:
blacklist:
supported
</code></pre>
</div>

<p>Each of the files in the specific <code class="highlighter-rouge">seeds</code> folder contains a list of packages
that looks something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code> * apt
 * conspy
 * dosfstools
 ...
</code></pre>
</div>

<p>Note the ` * ` at the beginning of each line - in particular the space in
front of the asterix! Where do we get this list of packages - from the
<code class="highlighter-rouge">packages</code> folder in the board specific folder in the <code class="highlighter-rouge">brickstrap</code> package.</p>

<p>I just do something like this to create the required package list:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat ev3dev-jessie/packages/* | sed 's/^/ * /' &gt; path/to/seed/required
</code></pre>
</div>

<p>Later on we’ll talk about adding packages to the other package list files
as needed.  To grow the crops that we’re going to need to populate the local
mirrors, we do the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/path-to-script/grow_crop ev3dev.debian.jessie.armel
/path-to-script/grow_crop ev3dev.ev3dev.jessie.armel
</code></pre>
</div>

<p>This will create a bunch of output in the corresponding <code class="highlighter-rouge">crops</code> folders. These
files will contain formatted output that contains all the packages you’ll
need for each crop in <code class="highlighter-rouge">required</code>, and incrementally more packages in <code class="highlighter-rouge">minimal</code>
and <code class="highlighter-rouge">standard</code>.</p>

<h3 id="harvesting-crops-and-populating-a-local-mirror">Harvesting Crops and Populating a Local Mirror</h3>

<p>To actually populate and update the local mirrors, the <a href="https://github.com/rhempel/growrepo"><code class="highlighter-rouge">growrepo</code></a>
repository has an additional helper
script called <code class="highlighter-rouge">harvest_crops</code> that strips the package names from the
formatted output of <code class="highlighter-rouge">germinate</code>. You pass it the name of the farm that grew the
crops, and which crops to harvest, like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/path-to-script/harvest_crop ev3dev.ev3dev.jessie.armel minimal required
</code></pre>
</div>

<p>This will spit out to standard output a list of packages that will reproduce
the packages you’ll want to install.</p>

<p>For bonus points, you can pipe the result through <code class="highlighter-rouge">sort</code> before writing the
output to the package file for <code class="highlighter-rouge">reprepro</code>. If you’re still with me, you’ll
know we have not yet discussed <code class="highlighter-rouge">reprepro</code> - so let’s move on with that and 
then tie everything together at the end.</p>

<h2 id="set-up-the-reprepro-system">Set Up The reprepro System</h2>

<p>Now we can focus on setting up <a href="http://mirrorer.alioth.debian.org"><code class="highlighter-rouge">reprepro</code></a> which is really not very difficult
at all. Recall that when we set up the <code class="highlighter-rouge">germinate</code> ecosystem, we used the
idea of “farms” to grow the package lists. We will re-use this idea and give
the local repositories their own directories - and the name will be the
same as the farm.</p>

<p>Using the Debian conventions, the top level repository mirror folders will
be stored in the <code class="highlighter-rouge">/srv/packages/</code> directory. We don’t strictly need it
now, but for future automation of <code class="highlighter-rouge">reprepro</code> you’re going to want to create
a <code class="highlighter-rouge">reprepro</code> system user like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo adduser --system --disabled-password --disabled-login \
             --home /srv/packages \
             --group reprepro
</code></pre>
</div>

<p>For the following sections on setting up <code class="highlighter-rouge">reprepro</code>, you’ll need to become
the <code class="highlighter-rouge">reprepro</code> user, but that user was configured with no login privileges.
We can do some <code class="highlighter-rouge">sudo</code> magic to work around that - note that your shell
prompt (if you’re using the default that comes with most Linux distributions)
will have changed:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>userid@machine:~$ sudo -u reprepro bash
reprepro@machine:/home/userid$ cd $HOME
reprepro@machine:~$ pwd
/srv/packages
reprepro@machine:~$ exit
userid@machine:~$
</code></pre>
</div>

<h3 id="create-folder-structure-for-each-local-respository">Create Folder Structure For Each Local Respository</h3>

<p>For <code class="highlighter-rouge">ev3dev</code> development, we’re going to create two repositories, one for 
the <code class="highlighter-rouge">ev3dev.org</code> packages and another for the standard Debian packages.
You can guess that to make things easy, the repository names will be
exactly the same as the <code class="highlighter-rouge">farms</code> that we grow the <code class="highlighter-rouge">crops</code> in.</p>

<p>Remember to become the <code class="highlighter-rouge">reprepro</code> user and then create the following
directories:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>for d in "conf" "gpg" "logs" "www"; do
    mkdir -p "/srv/packages/ev3dev.debian.jessie.armel/$d"
    mkdir -p "/srv/packages/ev3dev.ev3dev.jessie.armel/$d"
done

chmod 700 /srv/packages/ev3dev.debian.jessie.armel/gpg
chmod 700 /srv/packages/ev3dev.ev3dev.jessie.armel/gpg
</code></pre>
</div>

<p>Then create the file <code class="highlighter-rouge">conf/options</code> like this”</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat &lt;&lt;EOF &gt; "/srv/packages/ev3dev.debian.jessie.armel/conf/options"
outdir +b/www
logdir +b/logs
gnupghome +b/gpg
EOF

cat &lt;&lt;EOF &gt; "/srv/packages/ev3dev.ev3dev.jessie.armel/conf/options"
outdir +b/www
logdir +b/logs
gnupghome +b/gpg
EOF
</code></pre>
</div>

<p>Then we’ll set up the ev3dev repository <code class="highlighter-rouge">conf</code> files:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat &lt;&lt;EOF &gt; "$HOME/ev3dev.ev3dev.jessie.armel/conf/distributions"
Codename: jessie
Architectures: armel
Description: ev3dev (required packages only)
Components: main
Update: ev3dev-jessie-update
EOF

cat &lt;&lt;EOF &gt; "$HOME/ev3dev.ev3dev.jessie.armel/conf/options"
outdir +b/www
logdir +b/logs
gnupghome +b/gpg
EOF

cat &lt;&lt;EOF &gt; "$HOME/ev3dev.ev3dev.jessie.armel/conf/updates"
Name:  ev3dev-jessie-update
Method: http://archive.ev3dev.org/debian
VerifyRelease: 93178A7C
Suite: jessie
Components: main
Architectures: armel
FilterList: purge ../ev3dev.ev3dev.jessie.armel.packages
EOF
</code></pre>
</div>

<p>I’m using the University of Waterloo Debian mirror locations here, you
should use the closest mirror:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat &lt;&lt;EOF &gt; "$HOME/ev3dev.debian.jessie.armel/conf/distributions"
Codename: jessie
Architectures: armel
Description: debian (required packages only)
Components: main contrib non-free
Update: debian-jessie-update
EOF

cat &lt;&lt;EOF &gt; "$HOME/ev3dev.debian.jessie.armel/conf/options"
outdir +b/www
logdir +b/logs
gnupghome +b/gpg
EOF

cat &lt;&lt;EOF &gt; "$HOME/ev3dev.debian.jessie.armel/conf/updates"
Name:  debian-jessie-update
Method: http://mirror.csclub.uwaterloo.ca/debian
VerifyRelease: 8B48AD6246925553
Suite: jessie
Components: main contrib non-free
Architectures: armel
FilterList: purge ../ev3dev.debian.jessie.armel.packages
EOF
</code></pre>
</div>

<h3 id="get-the-gpg-keys-for-each-repository">Get the GPG Keys For Each Repository</h3>

<p>We are (hopefully) still the <code class="highlighter-rouge">reprepro</code> user - remember that the <code class="highlighter-rouge">$HOME</code>
for this user is <code class="highlighter-rouge">/srv/packages</code> and that’s where the <code class="highlighter-rouge">.gnupg</code> directory
will get created. Don’t worry, only the <code class="highlighter-rouge">reprepro</code> user has access to
it.</p>

<p>Pulling in and saving the keys for each repository is simple:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Get the ev3dev.org public signing key

gpg2 --keyserver pgp.mit.edu --recv-keys 2B210565
cd $HOME/ev3dev.ev3dev.jessie.armel
gpg2 --export 2B210565 | GNUPGHOME=gpg gpg --import --no-permission-warning

# Get the Debian Jessie public signing key

gpg2 --keyserver pgp.mit.edu --recv-keys 8B48AD6246925553
cd $HOME/ev3dev.debian.jessie.armel
gpg2 --export 8B48AD6246925553 | GNUPGHOME=gpg gpg --import --no-permission-warning

cd $HOME
</code></pre>
</div>

<h3 id="create-the-package-lists-and-populate-the-repositories">Create The Package Lists and Populate The Repositories</h3>

<p>We’re almost ready - all we need to do now is create the package
lists and populate the repositories. The package lists are easy
because we’ve got the <code class="highlighter-rouge">harvest_crop</code> script to help us.</p>

<p>Still as the <code class="highlighter-rouge">reprepro</code> user, all we need to do is run it like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd $HOME

FARM="ev3dev.ev3dev.jessie.armel"
/path/to/harvest_crop "$FARM" required minimal standard &gt; "$FARM.packeges"

FARM="ev3dev.debian.jessie.armel"
/path/to/harvest_crop "$FARM" required minimal standard  &gt; "$FARM/$FARM.packeges"
</code></pre>
</div>

<p>And then the final bit is to update the repositories:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd $HOME/ev3dev.ev3dev.jessie.armel
reprepro -V update jessie

cd $HOME/ev3dev.debian.jessie.armel
reprepro -V update jessie
</code></pre>
</div>

<h2 id="configuring-your-webserver-to-serve-packages">Configuring Your Webserver To Serve Packages</h2>

<p>As discussed near the beginning of this tutorial, I happen to like
using Hiawatha for serving up content. We need to configure Hiawatha
to create virtual hosts - this allows the server to associate a URL
with a particular source directory.</p>

<p>Whatever web server you use, the steps will be similar to these.</p>

<p>I’ve got Hiawatha set up to listen to the following adresses:</p>

<ul>
  <li><code class="highlighter-rouge">127.0.0.1:8080</code> localhost</li>
  <li><code class="highlighter-rouge">192.168.56.1:8080</code> VirtualBox HostOnly</li>
</ul>

<p>For Hiawatha, that looks like the following configuration stanzas:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Binding {
	Port = 8080
 	Interface = 127.0.0.1
}

Binding {
	Port = 8080
 	Interface = 192.168.56.1
}
</code></pre>
</div>

<p>Next, we need to configure the virtual host URLs, and associate
the root directory for the content. These stanzas handle it:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VirtualHost {
	Hostname = debian.jessie.armel.domain.com
	WebsiteRoot = /srv/packages/ev3dev.debian.jessie.armel/www
	ShowIndex = yes
 	AccessLogfile = /var/log/hiawatha/debian-access.log
 	ErrorLogfile = /var/log/hiawatha/debian-error.log
	FollowSymlinks = yes
}

VirtualHost {
	Hostname = ev3dev.jessie.armel.domain.com
	WebsiteRoot = /srv/packages/ev3dev.ev3dev.jessie.armel/www
	ShowIndex = yes
 	AccessLogfile = /var/log/hiawatha/ev3dev-access.log
 	ErrorLogfile = /var/log/hiawatha/ev3dev-error.log
	FollowSymlinks = yes
}
</code></pre>
</div>

<p>No magic here - you’ll notice of course that the <code class="highlighter-rouge">farm</code> name
shows up again in the <code class="highlighter-rouge">Hostname</code> definition, and in the <code class="highlighter-rouge">WebsiteRoot</code>. 
Remember to chage <code class="highlighter-rouge">domain.com</code> to your local domain name.</p>

<p>The last step is to set up your local DNS server to direct the
<code class="highlighter-rouge">Hostname</code> URLs to one of the specific IP addresses that Hiawatha is bound
to.</p>

<p>If you don’t have a full blown DNS server, have no fear. The old-school
local DNS file under Linux is <code class="highlighter-rouge">/etc/hosts</code>, just add these two stanzas
to the <code class="highlighter-rouge">/etc/hosts</code> file:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>127.0.0.1	debian.jessie.armel.domain.com
127.0.0.1	ev3dev.jessie.armel.domain.com
</code></pre>
</div>

<p>Point your webserver at <code class="highlighter-rouge">debian.jessie.armel.domain.com:8080</code> and you
should see a directory listing with <code class="highlighter-rouge">dists/</code> and <code class="highlighter-rouge">pool/</code> in it.</p>

<h2 id="conclusion">Conclusion</h2>

<p>If you’ve followed along this far and had success, then give yourself
a pat on the back and go for a walk and enjoy the outdoors. You have
set a partial repository of the main Debian repository, built the <code class="highlighter-rouge">ev3dev</code>
compatible Linux kernel using a cross compiler, and possibly build the
SD card image for <code class="highlighter-rouge">ev3dev</code>.</p>


    
    </div>
    
    <div id="footer">

        <div class="cclicense">
    
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">
                www.ev3dev.org (with the exception of the projects pages)
            </span>
            is licensed under
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by-sa/4.0/80x15.png" />
            </a>.
            <br />
            You are free to copy the text and images, but please be courteous and acknowledge the source.
    
        </div>

    <br />
    <div class="container">
        <span>
            Project maintained by <a href="https://github.com/rhempel">Ralph Hempel</a>
            and <a href="https://github.com/dlech">David Lechner</a>, with help from the community
        </span>
    </div>
</div>

    

<!-- Custom styles -->
<link rel="stylesheet" href="/ev3dev.github.io/stylesheets/search.css">
<link rel="stylesheet" href="/ev3dev.github.io/stylesheets/page-content.css">
<link rel="stylesheet" href="/ev3dev.github.io/stylesheets/user-cards.css">
<link rel="stylesheet" href="/ev3dev.github.io/stylesheets/tabs.css">

<!-- Python code highlighting -->
<link rel="stylesheet" href="/ev3dev.github.io/stylesheets/pygments/monokai.css" />

<!-- 3rd-party libraries -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="/ev3dev.github.io/javascripts/bootstrap/bootstrap.min.js"></script>
<script src="/ev3dev.github.io/javascripts/jquery.getUrlParam.js"></script>
<script src="/ev3dev.github.io/javascripts/jquery.loadTemplate-1.4.4.min.js"></script>
<script src="/ev3dev.github.io/javascripts/respond.js"></script>
<script src="/ev3dev.github.io/javascripts/ua-parser.min.js"></script>
<script src="https://unpkg.com/imagesloaded@4.1/imagesloaded.pkgd.min.js"></script>


<!-- Caches data from requests to API endpoints -->
<script src="/ev3dev.github.io/javascripts/api-cache.js"></script>
<!-- Loads user-cards from GH API -->
<script src="/ev3dev.github.io/javascripts/cards.js"></script>
<!-- Configures special anchors to link to the most recent ev3dev release -->
<script src="/ev3dev.github.io/javascripts/releases.js"></script>
<!-- Responds to queries typed into the "Quick nav" box -->
<script src="/ev3dev.github.io/javascripts/search.js"></script>
<!-- Converts static descriptors of tab target content into live text and links -->
<script src="/ev3dev.github.io/javascripts/tabs.js"></script>
<!-- Adds classes and other styles to pages where hard-coded css can't be used -->
<script src="/ev3dev.github.io/javascripts/style-helpers.js"></script>
</body>
</html>

